<?xml version="1.0" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc>
  <web>WebIDECode</web>
  <name>ApplicationHierarchy</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <parent>WebIDECode.ApplicationClass</parent>
  <creator>xwiki:XWiki.Admin</creator>
  <author>xwiki:XWiki.Admin</author>
  <customClass/>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <creationDate>1434700712000</creationDate>
  <date>1438073262000</date>
  <contentUpdateDate>1438072258000</contentUpdateDate>
  <version>1.1</version>
  <title>ApplicationHierarchy</title>
  <defaultTemplate/>
  <validationScript/>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <object>
    <class>
      <name>XWiki.JavaScriptExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>0</number>
    <className>XWiki.JavaScriptExtension</className>
    <guid>95d6ad85-599f-40f3-b936-d2312fb7a8df</guid>
    <property>
      <cache>forbid</cache>
    </property>
    <property>
      <code>require(['jquery'], function ($) {

$(function(){

  //-------------------------
  //------- Functions -------
  //-------------------------

  // Register all click events with a function. They have to be register each time a new page or folder is created and the hierarchy is updated.
  function initialization() {
    // Buttons to hide or show the hierarchy and resize the textarea 
    $('#hierarchyClose').click(function(e){
      $('#hierarchyContent').hide();
      $('#hierarchyOpenBlock').show();
      $("#hierarchyBlock").css({
        "min-width": "0px", 
        "width": "42px"
      });
      if(XWiki.contextaction == "edit") {
        $('#'+mainBlock).css({
          "maxWidth": "100%", 
          "width": ($('#'+mainBlockContainer).width()-42)+"px"
        });
      }
    });
    $('#hierarchyOpenBlock').click(function(e){
      $('#hierarchyOpenBlock').hide();
      $('#hierarchyContent').show();
      $("#hierarchyBlock").css({
        "minWidth": "17%", 
        "width": "17%"
      });
      if(XWiki.contextaction == "edit") {
        $('#'+mainBlock).css({
          "maxWidth": "83%", 
          "width": "83%"
        });
      }
    });

    // Display or hide the content of a folder by clicking on its name
    $('.hierarchy-toggleFolder').click(function(){
      var spaceToggle = $(this).attr('space');
      $(document.getElementById('hierarchySpace_'+spaceToggle)).toggle();
      var indexSpace = $.inArray(spaceToggle, hiddenSpaces);
      if($(document.getElementById('hierarchySpace_'+spaceToggle)).is(':hidden')) {
        if(indexSpace &lt; 0) {
          hiddenSpaces.push(spaceToggle);
        }
        $(document.getElementById('hierarchyFolderIcon_'+spaceToggle)).attr('src', '/xwiki/resources/icons/silk/bullet_toggle_plus.png');
      }
      else {
        if(indexSpace &gt;= 0) {
          hiddenSpaces.splice(indexSpace, 1);
        }
       $(document.getElementById('hierarchyFolderIcon_'+spaceToggle)).attr('src', '/xwiki/resources/icons/silk/bullet_toggle_minus.png');
      }
      setCookieHierarchy('hiddenSpaces', hiddenSpaces, 365);
    });
    // Display or hide the details of a page by clicking on its name
    $('.hierarchy-displayPage').click(function(){
      var pageToggle = $(this).attr('pageid');
      $(document.getElementById('hierarchyPageDetails_'+pageToggle)).toggle();
      var indexPage = $.inArray(pageToggle, hiddenPages);
      if($(document.getElementById('hierarchyPageDetails_'+pageToggle)).is(':hidden')) {
        if(indexPage &lt; 0) {
          hiddenPages.push(pageToggle);
        }
        $(this).find('.hierarchyDisplayPageIcon').attr('src', '/xwiki/resources/icons/silk/bullet_toggle_plus.png');
      }
      else {
        if(indexPage &gt;= 0) {
          hiddenPages.splice(indexPage, 1);
        }
        $(this).find('.hierarchyDisplayPageIcon').attr('src', '/xwiki/resources/icons/silk/bullet_toggle_minus.png');
      }
      setCookieHierarchy('hiddenPages', hiddenPages, 365);
    });

    // Add a page (if no bootstrap) / Change the folder to use when adding a new page
    $('.newPage').click(function(e){
      e.preventDefault();
      $('#hierarchyPageFolder').html(unescape($(this).attr("space")));
      if(!bootstrap) {
        var newPageNoBootstrap = prompt("Name of the new page:", "");
        if(newPageNoBootstrap != null) {
          $('#hierarchyNewPageName').val(newPageNoBootstrap);
          addPage();
        }
      }
    });
    // Add a folder (if no bootstrap)
    $('.newFolder').click(function(e){
      e.preventDefault();
      if(!bootstrap) {
        var newFodlerNoBootstrap = prompt("Name of the folder:", "");
        if(newFodlerNoBootstrap != null) {
          $('#hierarchyNewFolderName').val(newFodlerNoBootstrap);
          addFolder();
        }
      }
    });
    // Add an existing page (if no bootstrap)
    $('.newExistingPage').click(function(e){
      e.preventDefault();
      if(!bootstrap) {
        var newExistingPageNoBootstrap = prompt("Name of the existing page:", "");
        if(newExistingPageNoBootstrap != null) {
          $('#hierarchyExistingPageName').val(newExistingPageNoBootstrap);
          addExistingPage();
        }
      }
    });

    // Remove a folder by clicking on the cross
    $('.hierarchy-remove-folder').click(function(){
      removeFolder(decodeURI($(this).attr('space')));
    });
    // Remove a page by clicking on the cross
    $('.hierarchy-remove-page').click(function(){
      removePage(decodeURI($(this).attr('pageid')));
    });
    if(XWiki.editor == "wiki") {
      $(".hierarchy-remove").css({
        "backgroundColor" : $('div.leftmenu2').css('backgroundColor')
      });
    }

    $('.editPage').click(function(e){
      if(!saving &amp;&amp; !loading) {
        e.preventDefault();
        $('#hierarchyNextDocName').val($(this).attr('page'));
        $('#hierarchyNextDocSpace').val($(this).attr('space'));
        $('#hierarchyNextDocTitle').val($(this).attr('rawtitle'));

        if(XWiki.editor == "wiki"){
          if(savedContent != $('#content').val()) {
            if(bootstrap) {
              $('#hierarchyChangePageModal').modal('show');
            }
            else if(confirm("You have unsaved modifications. If you continue, all modifications will be lost.\nDo you want to continue?")) {
              loadPage(false);
            }
          }
          else {
            loadPage(false);
          }
        }
      }
    });

    // Load the new content and new title when the user click on a link in the hierarchy panel
    $('#hierarchySaveAndContinueModal, #hierarchyDiscardAndContinueModal').click(function(e){
      e.preventDefault();
      if(!saving &amp;&amp; !loading) {
        $('body').removeClass('modal-open');
        if($(this).attr('id') == 'hierarchySaveAndContinueModal') {
          loadPage(true);
        }
        else {
          loadPage(false);
        }
      }
    });

    // Reset page name and folder name in modals
    $('#hierarchyNewPageName').val('');
    $('#hierarchyNewFolderName').val('');
  }
  
  function setCookieHierarchy(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays*24*60*60*1000));
    var expires = "expires="+d.toUTCString();
    document.cookie = masterName+"-"+cname + "=" + cvalue + "; " + expires + ";path=/";
  }
  function getCookieHierarchy(cname) {
    var name = masterName+"-"+cname + "=";
    var ca = document.cookie.split(';');
    for(var i=0; i&lt;ca.length; i++) {
      var c = ca[i];
      while (c.charAt(0)==' ') c = c.substring(1);
      if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
    }
    return "";
  }

  //-------------------------
  //----- End functions -----
  //-------------------------

  // Variables
  var masterSpace = $('#hierarchyMasterDocSpace').val();
  var masterName = $('#hierarchyMasterDocName').val();
  var currentPage = encodeURIComponent(XWiki.currentPage);
  var currentSpace = encodeURIComponent(XWiki.currentSpace);
  var currentPageEscaped = encodeURIComponent(currentPage.replace(/\\/g, '\\').replace(/\./g, '\.'));
  var currentSpaceEscaped = encodeURIComponent(currentSpace.replace(/\\/g, '\\').replace(/\./g, '\.'));
  var saving = false;
  var loading = false;
  var hiddenSpaces = getCookieHierarchy('hiddenSpaces').split(',');
  var hiddenPages = getCookieHierarchy('hiddenPages').split(',');
  var mainBlock = '';
  var mainBlockContainer = '';
  var wikiGetURL = '/xwiki/bin/get/';
  if(window.docgeturl.indexOf('/get/') &gt;= 0) {
    wikiGetURL = window.docgeturl.substring(0,window.docgeturl.indexOf('/get/')+5);
  }
  var wikiViewURL = '/xwiki/bin/view/';
  if(window.docviewurl.indexOf('/'+XWiki.currentSpace+'/') &gt;= 0) {
    wikiViewURL = window.docviewurl.substring(0,window.docviewurl.indexOf('/'+XWiki.currentSpace+'/')+1);
  }
  if(typeof($.fn.modal) === 'undefined') {
    var bootstrap = false;
  }
  else {
    var bootstrap = true;
  }
  if(XWiki.contextaction =="view") {
    $('#hierarchyBlock').css({"resize" : "none"});
  }
  if(XWiki.editor == "wiki") {
    mainBlock = 'content';
    mainBlockContainer = 'xwikieditcontentinner';
    var savedContent = $('#content').val();
  }
  else if(XWiki.editor == "object"){
    mainBlock = 'update';
    mainBlockContainer = 'mainEditArea';
  }
  else if(XWiki.editor == "class"){
    mainBlock = 'propupdate';
    mainBlockContainer = 'mainEditArea';
  }
  // Autofocus on text inputs when a modal appears:
  if(bootstrap) {
    $('#hierarchyFolderModal').on('shown.bs.modal', function () {
      $('#hierarchyNewFolderName').focus();
    })
    $('#hierarchyPageModal').on('shown.bs.modal', function () {
      $('#hierarchyNewPageName').focus();
    })
    $('#hierarchyExistingPageModal').on('shown.bs.modal', function () {
      $('#hierarchyExistingPageName').focus();
    })
  }
  if(XWiki.editor == "wiki") {
    // Remove previous shortcuts to prevent saving modifications only in the page loaded at first
    shortcut.remove("Alt+Shift+S");
    shortcut.remove("Alt+S");
    shortcut.remove("Alt+C");
    shortcut.remove("Alt+P");

    // Add a star in the hierarchy if the content has changed
    $('#content').keyup(function(){
      if(savedContent != $('#content').val()) {
        $('#hierarchyStar').show();
      }
      else {
        $('#hierarchyStar').hide();
      }
    });

    // Add events on buttons and shortcuts
    $('#hierarchySaveButtonIDE').click(function(e){
      e.preventDefault();
      saveAndContinueIDE(currentSpace, currentPage, $('#content').val(), $('#xwikidoctitleinput').val(), true);
    });
    $('#hierarchySaveViewButtonIDE').click(function(e){
      e.preventDefault();
      saveAndViewIDE(currentSpace, currentPage, $('#content').val(), $('#xwikidoctitleinput').val(), true);
    });
    $('#hierarchyDiscardViewButtonIDE').click(function(e){
      e.preventDefault();
      cancelAndViewIDE();
    });
    shortcut.add("Alt+Shift+S", function() {saveAndContinueIDE(currentSpace, currentPage, $('#content').val(), $('#xwikidoctitleinput').val(), true);});
    shortcut.add("Alt+S", function() {saveAndViewIDE(currentSpace, currentPage, $('#content').val(), $('#xwikidoctitleinput').val(), true);});
    shortcut.add("Alt+C", function() {cancelAndViewIDE();});
  }
  if(XWiki.contextaction == 'edit') {
    //Remove "single character" shortcuts to prevent changing page if the input looses the focus
    shortcut.remove("E");
    shortcut.remove("K");
    shortcut.remove("G");
    shortcut.remove("F");
    shortcut.remove("R");
    shortcut.remove("O");
    shortcut.remove("S");
    shortcut.remove("D");
    shortcut.remove("W");
  }
  
  $('#hierarchyAddFolder').click(function(e){
    $('body').removeClass('modal-open');
    e.preventDefault();
    addFolder();
  });
  $('#hierarchyAddPage').click(function(e){
    $('body').removeClass('modal-open');
    e.preventDefault();
    addPage();
  });
  $('#hierarchyAddExistingPage').click(function(e){
    $('body').removeClass('modal-open');
    e.preventDefault();
    addExistingPage();
  });
  initialization();

  //-------------------------
  //---------- API ----------
  //-------------------------
  //
  //loadPage(boolean saveContent)
  //saveAndViewIDE(string space, string page, string newContent, string newTitle, boolean changeSavedContent)
  //saveAndContinueIDE(string space, string page, string newContent, string newTitle, boolean changeSavedContent)
  //cancelAndViewIDE()
  //reloadHierarchy()
  //removeFolder(string folder)
  //removePage(string page)
  //addFolder()
  //addPage()
  //addExistingPage()

  function loadPage(saveContent) {
    if(!loading) {
      loading = true;
      $('#hierarchyLoadingState').html('&lt;strong class="red"&gt;Loading...&lt;/strong&gt;');
      if(saveContent) {
        saveAndContinueIDE(currentSpace, currentPage, $('#content').val(), $('#xwikidoctitleinput').val(), false);
      }
      currentSpace = $('#hierarchyNextDocSpace').val();
      currentPage = $('#hierarchyNextDocName').val();
      currentPageEscaped = currentPage.replace(/\\/g, '%5C%5C').replace(/\./g, '%5C.');
      currentSpaceEscaped = currentSpace.replace(/\\/g, '%5C%5C').replace(/\./g, '%5C.');
      $('#hierarchyCurrentDocName').val(currentPage); // Used in the JSInjector file to know which is the current page to save
      $('#hierarchyCurrentDocSpace').val(currentSpace);
      $.ajax({
        url: wikiViewURL+currentSpace+"/"+currentPage+"?xpage=plain&amp;raw=1&amp;language=default",
        type: "GET",
        contentType: "plain/text",
      }).success(function(dataContent){
        var formattedData = dataContent.replace(/^&lt;pre&gt;/, '').replace(/&lt;\/pre&gt;$/, '');
        $('#content').val($('&lt;div /&gt;').html(formattedData).text());
        savedContent = $('#content').val();
        $('#xwikidoctitleinput').val(decodeURIComponent($('#hierarchyNextDocTitle').val()));
        $('#hierarchyNextDocTitle').val('');
        $('#hierarchyNewFolderName').val('');
        if(bootstrap) {
          $('#hierarchyChangePageModal').modal('hide');
        }
        reloadHierarchy();
        loading = false;
        $('#hierarchyLoadingState').html('&lt;strong class="green"&gt;Loaded&lt;/strong&gt;').show().delay(2500).queue(function(n) {
          $(this).hide().html('');
          n();
        });
      });
    }
  }

  function saveAndViewIDE(space, page, newContent, newTitle, changeSavedContent) {
    if(!saving) {
      saving = true;
      $('#hierarchySavingState').html('&lt;strong class="red"&gt;Saving...&lt;/strong&gt;');
      $.ajax({
        url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+space+"/pages/"+page,
        type: "PUT",
        contentType: "application/x-www-form-urlencoded",
        accept: "application/xml",
        data: "title="+encodeURIComponent(newTitle)+"&amp;content="+encodeURIComponent(newContent),
      }).error(function(){
        saving = false;
        $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
          $(this).hide().removeAttr('class').html('');
          n();
        });
        return false;
      }).success(function(data){
        if(changeSavedContent) {
          savedContent = $('#content').val();
        }
        $('#hierarchyStar').hide();
        $('#hierarchySavingState').html('&lt;strong class="green"&gt;Saved&lt;/strong&gt;').show().delay(2500).queue(function(n) {
          $(this).hide().html('');
          n();
        });
        saving = false;
        window.location.href = wikiViewURL+currentSpace+'/'+currentPage;
      });
    }
  }

  function saveAndContinueIDE(space, page, newContent, newTitle, changeSavedContent) {
    if(!saving) {
      saving = true;
      $('#hierarchySavingState').html('&lt;strong class="red"&gt;Saving...&lt;/strong&gt;');
      $.ajax({
        url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+space+"/pages/"+page,
        type: "PUT",
        contentType: "application/x-www-form-urlencoded",
        accept: "application/xml",
        data: "title="+encodeURIComponent(newTitle)+"&amp;content="+encodeURIComponent(newContent),
      }).error(function(xhr, errorStatus){
        saving = false;
        $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
          $(this).hide().removeAttr('class').html('');
          n();
        });
        return false;
      }).success(function(data){
        if(changeSavedContent) {
          savedContent = $('#content').val();
        }
        $('#hierarchyStar').hide();
        $('#hierarchySavingState').html('&lt;strong&gt;Saved&lt;/strong&gt;').show().delay(2500).queue(function(n) {
          $(this).hide().html('');
          n();
        });
        saving = false;
        return true;
      });
    }
  }

  function cancelAndViewIDE() {
    if(savedContent != $('#content').val()) {
      if(confirm("Are you sure?")) {
        window.location.href = wikiViewURL+currentSpace+'/'+currentPage;
      }
    }
    else {
      window.location.href = wikiViewURL+currentSpace+'/'+currentPage;
    }
  }

  function reloadHierarchy() {
    $.ajax({
      url: wikiGetURL+"WebIDECode/ApplicationHierarchy?xpage=plain",
      type: "GET",
      datatype : "html",
      data : "action="+XWiki.contextaction+"&amp;editor="+XWiki.editor+"&amp;masterPage="+masterSpace+"."+masterName+"&amp;remotePage="+currentSpaceEscaped+"."+currentPageEscaped+"&amp;hiddenSpaces="+encodeURIComponent(hiddenSpaces)+"&amp;hiddenPages="+encodeURIComponent(hiddenPages),
      contentType: "text/html",
    }).success(function(data){
      var result = $('&lt;div /&gt;').append(data).find('#hierarchyContent').html();
      $('#hierarchyContent').html(result);
      initialization();
    });
  }

  function removeFolder(folder) {
    $.ajax({
      url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/spaces",
      type: "GET",
      contentType: "application/xml",
    }).success(function(res){
      var oldSpaces = $(res).find('value').text();
      var spaceArray = oldSpaces.split('|');
      var indexSpace = $.inArray(folder, spaceArray)
      if(indexSpace &gt;= 0) {
        spaceArray.splice(indexSpace, 1);
        $.ajax({
          url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/spaces",
          type: "PUT",
          contentType: "application/x-www-form-urlencoded",
          accept: "application/xml",
          data: "property#spaces="+encodeURIComponent(spaceArray),
        }).success(function(){
          $('#hierarchySavingState').html('&lt;strong&gt;Folder removed from project&lt;/strong&gt;').show().delay(2500).queue(function(n) {
            $(this).hide().html('');
            n();
          });
          reloadHierarchy();
        }).error(function(xhr){
          $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
            $(this).hide().removeAttr('class').html('');
            n();
          });
        });
      }
    });
  }

  function removePage(page) {
    $.ajax({
      url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/pages",
      type: "GET",
      contentType: "application/xml",
    }).success(function(res){
      var oldPages = $(res).find('value').text();
      var pageArray = oldPages.split('|');
      var indexSpace = $.inArray(page, pageArray)
      if(indexSpace &gt;= 0) {
        pageArray.splice(indexSpace, 1);
        $.ajax({
          url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/pages",
          type: "PUT",
          contentType: "application/x-www-form-urlencoded",
          accept: "application/xml",
          data: "property#pages="+encodeURIComponent(pageArray),
        }).success(function(){
          $('#hierarchySavingState').html('&lt;strong&gt;Page removed from project&lt;/strong&gt;').show().delay(2500).queue(function(n) {
            $(this).hide().html('');
            n();
          });
          reloadHierarchy();
        }).error(function(xhr){
          $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
            $(this).hide().removeAttr('class').html('');
            n();
          });
        });
      }
    });
  }

  /* 
  ** Add a folder in the hierarchy list :
  ** 1/ Check that the folder doesn't already exists
  ** 2/ Add the folder in the list alphabetically sorted
  ** 3/ Update the hierarchy
  */
  function addFolder() {
    var newFolder = $('#hierarchyNewFolderName').val();
    $.ajax({
      url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/spaces",
      type: "GET",
      contentType: "application/xml",
    }).success(function(res){
      var oldSpaces = $(res).find('value').text();
      var spaceArray = oldSpaces.split('|');
      if($.inArray(newFolder, spaceArray) == -1) {
        spaceArray.push(newFolder);
        spaceArray = spaceArray.sort();
        $.ajax({
          url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/spaces",
          type: "PUT",
          contentType: "application/x-www-form-urlencoded",
          accept: "application/xml",
          data: "property#spaces="+encodeURIComponent(spaceArray),
        }).success(function(){
          $('#hierarchyNewFolderName').val('');
          if(bootstrap) {
            $('#hierarchyFolderModal').modal('hide');
          }
          $('#hierarchySavingState').html('&lt;strong&gt;Folder added&lt;/strong&gt;').show().delay(4000).queue(function(n) {
            $(this).hide().html('');
            n();
          });
          reloadHierarchy();
        }).error(function(xhr){
          $('#hierarchyNewFolderName').val('');
          if(bootstrap) {
            $('#hierarchyFolderModal').modal('hide');
          }
          $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
            $(this).hide().removeAttr('class').html('');
            n();
          });
        });
      }
    });
  }

  /* 
  ** Add a page in a folder :
  ** 1/ Check that the page doesn't already exists
  ** 2/ Create the page in the wiki
  ** 3/ Update the hierarchy
  */
  function addPage() {
    var folder = encodeURIComponent(unescape($('#hierarchyPageFolder').text()));
    var newPage = encodeURIComponent($('#hierarchyNewPageName').val());
    $.ajax({
      url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+folder+"/pages/"+newPage,
      type: "GET",
      contentType: "application/xml",
    }).success(function(xhr){
      if(bootstrap) {
        $('#hierarchyExistingPageModalError').html('ERROR : A page with the same name already exist').show().delay(4000).queue(function(n) {
          $(this).hide().html('');
          n();
        });
      }
      else {
        alert('That page doesn\'t exist!');
      }
    }).error(function(res){
      $.ajax({
        url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+folder+"/pages/"+newPage,
        type: "PUT",
        contentType: "application/x-www-form-urlencoded",
        accept: "application/xml",
        data: "title="+newPage+"&amp;parent="+currentSpaceEscaped+"."+currentPageEscaped,
      }).success(function(){
        $('#hierarchyNewPageName').val('');
        if(bootstrap) {
          $('#hierarchyPageModal').modal('hide');
        }
        $('#hierarchySavingState').html('&lt;strong&gt;Page added&lt;/strong&gt;').show().delay(4000).queue(function(n) {
          $(this).hide().html('');
          n();
        });
        reloadHierarchy();
      }).error(function(xhr){
        $('#hierarchyNewPageName').val('');
        if(bootstrap) {
          $('#hierarchyPageModal').modal('hide');
        }
        $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
          $(this).hide().removeAttr('class').html('');
          n();
        });
      });
    });
  }

  /* 
  ** Add an existing page in the hierarchy list :
  ** 1/ Check that the page exists
  ** 2/ Add the page in the list alphabetically sorted
  ** 3/ Update the hierarchy
  */
  function addExistingPage() {
    var existingPage = $('#hierarchyExistingPageName').val();
    var existingPageSpace = existingPage.substr(0,existingPage.indexOf('.'));
    var existingPageName = existingPage.substr(existingPage.indexOf('.')+1);
    $.ajax({
      url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+existingPageSpace+"/pages/"+existingPageName,
      type: "GET",
      contentType: "application/xml",
    }).error(function(){
      if(bootstrap) {
        $('#hierarchyExistingPageModalError').html('ERROR : Unexisting page').show().delay(4000).queue(function(n) {
          $(this).hide().html('');
          n();
        });
      }
      else {
        alert('That page doesn\'t exist!');
      }
    }).success(function(){
      $.ajax({
        url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/pages",
        type: "GET",
        contentType: "application/xml",
      }).success(function(res){
        var oldPages = $(res).find('value').text();
        var pageArray = oldPages.split('|');
        if($.inArray(existingPage, pageArray) == -1) {
          pageArray.push(existingPage);
          pageArray = pageArray.sort();
          $.ajax({
            url: "/xwiki/rest/wikis/"+XWiki.currentWiki+"/spaces/"+masterSpace+"/pages/"+masterName+"/objects/WebIDECode.ApplicationClass/0/properties/pages",
            type: "PUT",
            contentType: "application/x-www-form-urlencoded",
            accept: "application/xml",
            data: "property#pages="+encodeURIComponent(pageArray),
          }).success(function(){
            $('#hierarchyExistingPageName').val('');
            if(bootstrap) {
              $('#hierarchyExistingPageModal').modal('hide');
            }
            $('#hierarchySavingState').html('&lt;strong&gt;Page added&lt;/strong&gt;').show().delay(4000).queue(function(n) {
              $(this).hide().html('');
              n();
            });
            reloadHierarchy();
          }).error(function(xhr){
            $('#hierarchyExistingPageName').val('');
            if(bootstrap) {
              $('#hierarchyExistingPageModal').modal('hide');
            }
            $('#hierarchySavingState').attr('class', 'red').html('&lt;strong&gt;'+xhr.statusText+'&lt;/strong&gt;').show().delay(4000).queue(function(n) {
              $(this).hide().removeAttr('class').html('');
              n();
            });
          });
        }
      });
    });
  }

});
});</code>
    </property>
    <property>
      <name>Hierarchy panel</name>
    </property>
    <property>
      <parse/>
    </property>
    <property>
      <use>onDemand</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.StyleSheetExtension</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <cache>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>cache</name>
        <number>5</number>
        <prettyName>Caching policy</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>long|short|default|forbid</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </cache>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>2</number>
        <prettyName>Code</prettyName>
        <rows>20</rows>
        <size>50</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>6</number>
        <prettyName>Content Type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>CSS|LESS</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <parse>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>parse</name>
        <number>4</number>
        <prettyName>Parse content</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </parse>
      <use>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>use</name>
        <number>3</number>
        <prettyName>Use this extension</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator> </separator>
        <separators> ,|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>currentPage|onDemand|always</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </use>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>0</number>
    <className>XWiki.StyleSheetExtension</className>
    <guid>0c7773fa-9a7a-49a4-b0db-44800f0bf911</guid>
    <property>
      <cache>forbid</cache>
    </property>
    <property>
      <code>#template('colorThemeInit.vm')

/* Hierarchy Block */
#hierarchyBlock {
  background-color: $theme.fieldGradientColor;
  min-width: 17%;
  width: 17%;
  overflow-y: auto;
  overflow-x: hidden;
  float: left;
  display: inline-block;
  resize: vertical;
  padding-right: 0px;
}
/* Project Block */
#hierarchyContent {
  overflow-x: hidden;
  padding:5px;
  height : 95%;
}
#hierarchyMainList {
  -webkit-user-select: none;  /* Chrome all / Safari all */
  -moz-user-select: none;     /* Firefox all */
  -ms-user-select: none;      /* IE 10+ */
  user-select: none;
}
#hierarchyMainList li {
  overflow: hidden;
  white-space: nowrap;
  position: relative;
  -webkit-user-select: none;  /* Chrome all / Safari all */
  -moz-user-select: none;     /* Firefox all */
  -ms-user-select: none;      /* IE 10+ */
  user-select: none;
}
.hierarchy-right {
  cursor: pointer;
  float: right;
}
.hierarchy-remove {
  position: absolute;
  background-color: $theme.fieldGradientColor;
  right: 0px;
  top: 0px;
  padding: 1px;
}
#hierarchyOpenBlock {
  cursor: pointer;
  padding-top: 5px;
  padding-bottom: 5px;
  text-align: center;
}

/* Project Block - Colibri skin */
#hierarchyContent ul {
  margin: 0px;
}
.hierarchy-list p {
  margin: 0px !important;
}
.hierarchy-list img {
  padding: 0px !important;
}

/* Project Content */
.hierarchy-list {
  list-style-type: none;
  padding-left: 25px;
  margin: 0px;
}
.hierarchy-list p {
  margin: 0px;
}
.hierarchy-no-padding {
  padding-left: 0px;
}
.hierarchy-hidden {
  display: none;
}
.hierarchy-toggleFolder {
  cursor: pointer;
  display: inline-block;
}
.hierarchy-toggleFolder:hover span{
  text-decoration: underline;
}
.hierarchy-toggleFolder p{
  margin-bottom:0;
}
.hierarchy-displayPage {
  cursor: pointer;
  display: inline-block;
}
.hierarchyCurrentSpacePageAction{
  font-weight: bold;
}
.hierarchy-displayPage:hover span{
  text-decoration: underline;
}
.hierarchy-displayPage p{
  margin-bottom:0;
}
.hierarchyContextActionIcon {
  margin-right: 5px;
}
/* Page state info */
#hierarchySavingState, #hierarchyLoadingState {
  float: right;
  background-color: green;
  color: white;
  border: 2px solid grey;
  padding: 2px;
  display: none;
}
#hierarchySavingState.red, #hierarchyLoadingState.red {
  background-color: red;
}
#hierarchyBottomActionsBar {
  padding-left: 18%;
  padding-right: 2%;
}
#hierarchyExistingPageModalError, #hierarchyPageModalError {
  font-weight: bold;
  color: #8A0808;
}</code>
    </property>
    <property>
      <contentType>CSS</contentType>
    </property>
    <property>
      <name>Hierarchy CSS</name>
    </property>
    <property>
      <parse>1</parse>
    </property>
    <property>
      <use>always</use>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <code>
        <disabled>0</disabled>
        <name>code</name>
        <number>9</number>
        <prettyName>Macro code</prettyName>
        <rows>20</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </code>
      <contentDescription>
        <disabled>0</disabled>
        <name>contentDescription</name>
        <number>8</number>
        <prettyName>Content description (Not applicable for "No content" type)</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </contentDescription>
      <contentType>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>contentType</name>
        <number>7</number>
        <prettyName>Macro content type</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Optional|Mandatory|No content</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </contentType>
      <defaultCategory>
        <disabled>0</disabled>
        <name>defaultCategory</name>
        <number>4</number>
        <prettyName>Default category</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultCategory>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>3</number>
        <prettyName>Macro description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <id>
        <disabled>0</disabled>
        <name>id</name>
        <number>1</number>
        <prettyName>Macro id</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </id>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>2</number>
        <prettyName>Macro name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
      <supportsInlineMode>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>supportsInlineMode</name>
        <number>5</number>
        <prettyName>Supports inline mode</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </supportsInlineMode>
      <visibility>
        <cache>0</cache>
        <disabled>0</disabled>
        <displayType>select</displayType>
        <multiSelect>0</multiSelect>
        <name>visibility</name>
        <number>6</number>
        <prettyName>Macro visibility</prettyName>
        <relationalStorage>0</relationalStorage>
        <separator>|</separator>
        <separators>|</separators>
        <size>1</size>
        <unmodifiable>0</unmodifiable>
        <values>Current User|Current Wiki|Global</values>
        <classType>com.xpn.xwiki.objects.classes.StaticListClass</classType>
      </visibility>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>0</number>
    <className>XWiki.WikiMacroClass</className>
    <guid>9d820c7a-33c4-436d-82c4-2a86e8095709</guid>
    <property>
      <code>{{velocity}}
#set($discard = $xwiki.jsx.use("WebIDECode.ApplicationHierarchy"))
#set($discard = $xwiki.ssx.use("WebIDECode.ApplicationHierarchy"))
#set($masterDoc = 'Main.WebHome')
#if($xwiki.exists($xcontext.macro.params.masterPage))
  #set($masterDoc = $xwiki.getDocument($xcontext.macro.params.masterPage))
#elseif($xwiki.exists($util.decodeURI($xcontext.macro.params.masterPage)))
  #set($masterDoc = $xwiki.getDocument($util.decodeURI($xcontext.macro.params.masterPage)))
#end
#if($xwiki.exists($xcontext.macro.params.remotePage))
  #set($currentDoc = $xwiki.getDocument($xcontext.macro.params.remotePage))
#elseif($xwiki.exists($util.decodeURI($xcontext.macro.params.remotePage)))
  #set($currentDoc = $xwiki.getDocument($util.decodeURI($xcontext.macro.params.remotePage)))
#else
  #set($currentDoc = $doc)
#end
#set($currentEditor = $!{xcontext.macro.params.editor})
#if("$!{xcontext.macro.params.hiddenSpaces}" != "")
  #set($hiddenSpacesString = $!{xcontext.macro.params.hiddenSpaces})
#end
#set($hiddenSpaces = $!hiddenSpacesString.split("[,]"))
#if("$!{xcontext.macro.params.hiddenPages}" != "")
  #set($hiddenPagesString = $!{xcontext.macro.params.hiddenPages})
#end
#set($hiddenPages = $!hiddenPagesString.split("[,]"))
(% class="hierarchy-hidden" id="hierarchyOpenBlock" %)(((
[[image:icon:control_end_blue||title="Open hierarchy"]]
)))
#set($masterObj = $masterDoc.getObject('WebIDECode.ApplicationClass'))
#set($spacesListInit = $masterObj.getProperty('spaces').value)
#set($spacesList = $sorttool.sort($masterObj.getProperty('spaces').value))
#set($spacesListAdd = [])
#set($pagesList = $sorttool.sort($masterObj.getProperty('pages').value))
#foreach($page in $pagesList)
  #set($document = $xwiki.getDocument($page))
  #if(!$spacesList.contains($document.space))
    #set($discard = $spacesList.add($document.space))
  #end
#end
#set($spacesList = $sorttool.sort($spacesList))
(% id="hierarchyContent" %) (((
(% class="hierarchy-right" id="hierarchyCloseBlock" %)(((
[[image:icon:control_start_blue||title="Hide hierarchy" id="hierarchyClose" class="hierarchy-right"]]
)))
//**Project** :// **[[$masterObj.getProperty('projectName').value&gt;&gt;$masterDoc.fullName||target="_blank"]]** 
(% class="hierarchy-list hierarchy-no-padding" id="hierarchyMainList" %)
#foreach($space in $spacesList)
  #set($spaceEscaped = $util.encodeURI($space).replace("+", "%20"))
  #set($spaceEscapedBackslash = $util.encodeURI($space.replace('\', '\\').replace('.', '\.')).replace("+", "%20"))
  #if($hiddenSpaces.contains($spaceEscapedBackslash) &amp;&amp; $space != $currentDoc.space)
    #set($contentDisplay = " hierarchy-hidden")
    #set($folderIcon = "bullet_toggle_plus")
  #else
    #set($contentDisplay = "")
    #set($folderIcon = "bullet_toggle_minus")
  #end
  #set($displayCurrentSpace = '')
  #if($space == $currentDoc.space)
    #set($displayCurrentSpace = ' class="hierarchyCurrentSpacePageAction"')
  #end
  #set($addRemoveButton = "")
  #if($spacesListInit.contains($space))
    #set($addRemoveButton = "[[image:icon:cross||title='Remove folder $spaceEscaped' space='$spaceEscaped' class='hierarchy-right hierarchy-remove hierarchy-remove-folder']]")
  #end 
  * (% class="hierarchy-toggleFolder" space="$spaceEscapedBackslash" %)((([[image:icon:$folderIcon||id="hierarchyFolderIcon_$spaceEscapedBackslash"]][[image:icon:folder]] {{html clean=false}}&lt;span$!{displayCurrentSpace}&gt;$space&lt;/span&gt; {{/html}}))) $!addRemoveButton
  #if($spacesListInit.contains($space))
    #set($spacePageList = $xwiki.getSpaceDocsName($space))
  #else
    #set($spacePageList = [])
    #foreach($page in $pagesList)
      #set($document = $xwiki.getDocument($page))
      #if($space == $document.space)
        #set($discard = $spacePageList.add($document.name))
      #end
    #end
    #set($spacePageList = $sorttool.sort($spacePageList))
  #end
  (% id="hierarchySpace_$spaceEscapedBackslash" class="hierarchy-list${contentDisplay}" %)
  #foreach($page in $spacePageList)
    #set($pageFullName = "${space.replace('\', '\\').replace('.', '\.')}.${page.replace('\', '\\').replace('.', '\.')}")
    #set($pageFullNameEscaped = $util.encodeURI($pageFullName).replace("+", "%20"))
    #set($pageRawTitleEscaped = $util.encodeURI($xwiki.getDocument($pageFullName).title).replace("+", "%20"))
    #set($pageClassHidden = "")
    #set($iconBulletToggle = "bullet_toggle_minus")
    #if($hiddenPages.contains($pageFullNameEscaped) &amp;&amp; $pageFullName != $currentDoc.fullName)
      #set($pageClassHidden = " hierarchy-hidden")
      #set($iconBulletToggle = "bullet_toggle_plus")
    #end
    #set($pageEscaped = $util.encodeURI($page).replace("+", "%20"))
    #set($pageEscapedBackslash = $util.encodeURI($page.replace('\', '\\').replace('.', '\.')).replace("+", "%20"))
    #if($xcontext.action != "edit" &amp;&amp; "$!{xcontext.macro.params.action}" != "edit")
      #set($displayedIcon = 'page')
    #elseif($currentEditor == "object")
      #set($displayedIcon = 'application_edit')
    #elseif($currentEditor == "class")
      #set($displayedIcon = 'monitor_edit')
    #else
      #set($displayedIcon = 'page_edit')
    #end
    #if($pageFullName == $currentDoc.fullName)
      #set($pageName = "{{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;$page&lt;/span&gt;{{/html}})))")
    #else
      #set($pageName = "{{html}}&lt;span&gt;$page&lt;/span&gt;{{/html}})))")
    #end
    #set($addRemoveButton = "")
    #if($pagesList.contains($pageFullName))
      #set($addRemoveButton = "[[image:icon:cross||title='Remove page $pageFullNameEscaped' pageid='$pageFullNameEscaped' class='hierarchy-right hierarchy-remove hierarchy-remove-page']]")
    #end
    #set($attachmentCount = $xwiki.getDocument($pageFullName).getAttachmentList().size())
    #if($xwiki.getDocument($pageFullName).hasAccessLevel('edit'))
      #set($objectCount = $services.query.xwql("select count(obj.className) from BaseObject as obj, Document as doc where obj.name  = doc.fullName and doc.fullName = :pageFullName and doc.translation=0").bindValue('pageFullName', $pageFullName).execute()[0])
      #set($classCount = $xwiki.getClass($pageFullName).properties.size())
      ** (% pageid="$spaceEscapedBackslash.$pageEscapedBackslash" class="hierarchy-displayPage" %)((([[image:icon:$iconBulletToggle||class="hierarchyDisplayPageIcon"]][[image:icon:$displayedIcon||class="hierarchyContextActionIcon"]]$pageName $!addRemoveButton
      (% id='hierarchyPageDetails_$spaceEscapedBackslash.$pageEscapedBackslash' class='hierarchy-list${pageClassHidden}' %)
      #if($xcontext.action != "edit" &amp;&amp; "$!{xcontext.macro.params.action}" != "edit" &amp;&amp; $pageFullName == $currentDoc.fullName)
        *** image:icon:page {{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;View&lt;/span&gt;{{/html}}
      #else
        *** [[image:icon:page View&gt;&gt;path:$xwiki.getURL("$pageFullName", 'view')]]
      #end
      #if($currentEditor == "wiki" &amp;&amp; $pageFullName == $currentDoc.fullName)
        *** image:icon:page_edit {{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;Edit (wiki) &lt;span id="hierarchyStar" class="hierarchy-hidden"&gt;*&lt;/span&gt;&lt;/span&gt;{{/html}}
      #elseif($currentEditor == "wiki")
        *** image:icon:page_edit {{html clean=false}}&lt;a href='#!XWebIDE' space='$spaceEscaped' page='$pageEscaped' rawtitle="$pageRawTitleEscaped" class='editPage'&gt;Edit (wiki)&lt;/a&gt;{{/html}}
      #else
        *** [[image:icon:page_edit Edit (wiki)&gt;&gt;path:$xwiki.getURL("$pageFullName", 'edit', 'language=default&amp;editor=wiki')#!XWebIDE]]
      #end
      #if($currentEditor == "object" &amp;&amp; $pageFullName == $currentDoc.fullName)
        *** image:icon:application_edit {{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;Objects ($objectCount)&lt;/span&gt;{{/html}}
      #else
        *** [[image:icon:application_edit Objects ($objectCount)&gt;&gt;path:$xwiki.getURL("$pageFullName", 'edit', 'editor=object')#!XWebIDE]]
      #end
      #if($currentEditor == "class" &amp;&amp; $pageFullName == $currentDoc.fullName)
        *** image:icon:monitor_edit {{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;Class ($classCount)&lt;/span&gt;{{/html}}
      #else
        *** [[image:icon:monitor_edit Class ($classCount)&gt;&gt;path:$xwiki.getURL("$pageFullName", 'edit', 'editor=class')#!XWebIDE]]
      #end
      *** [[image:icon:attach Attachments ($attachmentCount)&gt;&gt;path:$xwiki.getURL("$pageFullName", 'view')#Attachments]]
    #elseif($xwiki.getDocument($pageFullName).hasAccessLevel('view'))
      ** (% pageid="$spaceEscapedBackslash.$pageEscapedBackslash" class="hierarchy-displayPage" %)((([[image:icon:$iconBulletToggle||class="hierarchyDisplayPageIcon"]][[image:icon:$displayedIcon||class="hierarchyContextActionIcon"]]$pageName $!addRemoveButton
      (% id='hierarchyPageDetails_$spaceEscapedBackslash.$pageEscapedBackslash' class='hierarchy-list${pageClassHidden}' %)
      #if($xcontext.action != "edit" &amp;&amp; "$!{xcontext.macro.params.action}" != "edit" &amp;&amp; $pageFullName == $currentDoc.fullName)
        *** image:icon:page {{html}}&lt;span class='hierarchyCurrentSpacePageAction'&gt;View&lt;/span&gt;{{/html}}
      #else
        *** [[image:icon:page View&gt;&gt;path:$xwiki.getURL("$pageFullName", 'view')]]
      #end
      *** [[image:icon:attach Attachments ($attachmentCount)&gt;&gt;path:$xwiki.getURL("$pageFullName", 'view')#Attachments]]
    #end
  #end
  #if($xwiki.hasAccessLevel('edit', "$spaceEscaped.$reservedDocumentName")) ## Check if the user can create a page in that space
    ** image:icon:add {{html}}&lt;a href="#!XWebIDE" space="$spaceEscaped" class="newPage" data-toggle="modal" data-target="#hierarchyPageModal"&gt;Add new page&lt;/a&gt;{{/html}}
  #end
#end
#if($masterDoc.hasAccessLevel('edit'))
  * image:icon:add {{html}}&lt;a href="#!XWebIDE" class="newFolder" data-toggle="modal" data-target="#hierarchyFolderModal"&gt;Add new/existing folder&lt;/a&gt;{{/html}}
  * image:icon:add {{html}}&lt;a href="#!XWebIDE" class="newExistingPage" data-toggle="modal" data-target="#hierarchyExistingPageModal"&gt;Add existing page&lt;/a&gt;{{/html}}
#end
)))

{{html}}
## Modal should not add #!XWebIDE when the macro is used in view mode (e.g. in the master page)
#if($xcontext.action == "edit")
  #set($anchorHash = "!XWebIDE")
#end
  &lt;div class="modal fade text-left hierarchy-hidden" id="hierarchyFolderModal" tabindex="-1" role="dialog" aria-labelledby="hierarchyFolderModalLabel" aria-hidden="true"&gt;
    &lt;div class="modal-dialog"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
          &lt;h4 class="modal-title"&gt;Add New Folder&lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          Folder : &lt;input type="text" id="hierarchyNewFolderName" /&gt;
          &lt;a href="#$!{anchorHash}" id="hierarchyAddFolder" class="btn btn-success"&gt;Add the folder&lt;/a&gt;&lt;br&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="modal fade text-left hierarchy-hidden" id="hierarchyPageModal" tabindex="-1" role="dialog" aria-labelledby="hierarchyPageModalLabel" aria-hidden="true"&gt;
    &lt;div class="modal-dialog"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
          &lt;h4 class="modal-title"&gt;Add New Page&lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          Folder : &lt;span id="hierarchyPageFolder"&gt;&lt;/span&gt;&lt;br /&gt;
          Page : &lt;input type="text" id="hierarchyNewPageName" /&gt;
          &lt;a href="#$!{anchorHash}" id="hierarchyAddPage" class="btn btn-success"&gt;Add the page&lt;/a&gt;&lt;br&gt;
          &lt;p id="hierarchyPageModalError" class="hierarchy-hidden"&gt;&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="modal fade text-left hierarchy-hidden" id="hierarchyExistingPageModal" tabindex="-1" role="dialog" aria-labelledby="hierarchyExistingPageModalLabel" aria-hidden="true"&gt;
    &lt;div class="modal-dialog"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
          &lt;h4 class="modal-title"&gt;Add Existing Page&lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          Page Full Name : &lt;input type="text" id="hierarchyExistingPageName" /&gt;
          &lt;a href="#$!{anchorHash}" id="hierarchyAddExistingPage" class="btn btn-success"&gt;Add the page&lt;/a&gt;
          &lt;p id="hierarchyExistingPageModalError" class="hierarchy-hidden"&gt;&lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="modal fade text-left hierarchy-hidden" id="hierarchyChangePageModal" tabindex="-1" role="dialog" aria-labelledby="hierarchyChangePageModalLabel" aria-hidden="true"&gt;
    &lt;div class="modal-dialog"&gt;
      &lt;div class="modal-content"&gt;
        &lt;div class="modal-header"&gt;
          &lt;button type="button" class="close" data-dismiss="modal" aria-hidden="true"&gt;×&lt;/button&gt;
          &lt;h4 class="modal-title"&gt;Unsaved content&lt;/h4&gt;
        &lt;/div&gt;
        &lt;div class="modal-body"&gt;
          &lt;p&gt;
            You have unsaved content, do you want to continue? All unsaved modifications will be lost permanently&lt;br /&gt;
            #if($xcontext.action == "edit")
              #set
            #end
            &lt;a href="#$!{anchorHash}" id="hierarchySaveAndContinueModal" class="btn btn-success"&gt;Save &amp; Continue&lt;/a&gt; &lt;a href="#$!{anchorHash}" id="hierarchyDiscardAndContinueModal" class="btn btn-primary"&gt;Continue without saving&lt;/a&gt; &lt;button class="btn btn-default" data-dismiss="modal" type="button"&gt;Cancel&lt;/button&gt;
          &lt;/p&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;div class="hierarchy-hidden"&gt;&lt;input type="hidden" id="hierarchyMasterDocName" value="$escapetool.url($masterDoc.name)" /&gt;&lt;input type="hidden" id="hierarchyMasterDocSpace" value="$escapetool.url($masterDoc.space)" /&gt;&lt;input type="hidden" id="hierarchyCurrentDocName" value="$escapetool.url($doc.name)" /&gt;&lt;input type="hidden" id="hierarchyCurrentDocSpace" value="$escapetool.url($doc.space)" /&gt;&lt;input type="hidden" id="hierarchyNextDocName" value="" /&gt;&lt;input type="hidden" id="hierarchyNextDocSpace" value="" /&gt;&lt;input type="hidden" id="hierarchyNextDocTitle" value="" /&gt;&lt;/div&gt;
{{/html}}

{{/velocity}}</code>
    </property>
    <property>
      <contentDescription/>
    </property>
    <property>
      <contentType>No content</contentType>
    </property>
    <property>
      <defaultCategory/>
    </property>
    <property>
      <description>A macro which displays the hierarchy of the current project in the IDE application.</description>
    </property>
    <property>
      <id>displayHierarchy</id>
    </property>
    <property>
      <name>Display Project Hierarchy</name>
    </property>
    <property>
      <supportsInlineMode/>
    </property>
    <property>
      <visibility>Current Wiki</visibility>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>0</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>bc1ca3e7-c410-4a30-abda-2f8201f61fa1</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>The master page of the project you are working on.</description>
    </property>
    <property>
      <mandatory>1</mandatory>
    </property>
    <property>
      <name>masterPage</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>1</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>595fefaf-7e55-48ac-9a5e-0c5a9fad22f6</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>The action needed for the hierarchy "panel" : "edit", "view", etc...</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>action</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>2</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>288afa70-9c0c-45b3-b740-97692198c48f</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>The full-name of the page where the hierarchy must be displayed</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>remotePage</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>3</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>f214d5b0-880a-4f3d-97bc-90daa3fc4d5a</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>List of spaces which were hidden by the user in the hierarchy</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>hiddenSpaces</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>4</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>df7cb2f4-bb44-40ee-96f8-3fb59a0d9ede</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>Select the editor to use in the links of the hierarchy panel.</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>editor</name>
    </property>
  </object>
  <object>
    <class>
      <name>XWiki.WikiMacroParameterClass</name>
      <customClass/>
      <customMapping/>
      <defaultViewSheet/>
      <defaultEditSheet/>
      <defaultWeb/>
      <nameField/>
      <validationScript/>
      <defaultValue>
        <disabled>0</disabled>
        <name>defaultValue</name>
        <number>4</number>
        <prettyName>Parameter default value</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </defaultValue>
      <description>
        <disabled>0</disabled>
        <name>description</name>
        <number>2</number>
        <prettyName>Parameter description</prettyName>
        <rows>5</rows>
        <size>40</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.TextAreaClass</classType>
      </description>
      <mandatory>
        <disabled>0</disabled>
        <displayFormType>select</displayFormType>
        <displayType>yesno</displayType>
        <name>mandatory</name>
        <number>3</number>
        <prettyName>Parameter mandatory</prettyName>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.BooleanClass</classType>
      </mandatory>
      <name>
        <disabled>0</disabled>
        <name>name</name>
        <number>1</number>
        <prettyName>Parameter name</prettyName>
        <size>30</size>
        <unmodifiable>0</unmodifiable>
        <classType>com.xpn.xwiki.objects.classes.StringClass</classType>
      </name>
    </class>
    <name>WebIDECode.ApplicationHierarchy</name>
    <number>5</number>
    <className>XWiki.WikiMacroParameterClass</className>
    <guid>4393300f-918a-4ab8-9c32-b9ead664f975</guid>
    <property>
      <defaultValue/>
    </property>
    <property>
      <description>List of pages which were hidden by the user in the hierarchy</description>
    </property>
    <property>
      <mandatory>0</mandatory>
    </property>
    <property>
      <name>hiddenPages</name>
    </property>
  </object>
  <content>{{velocity}}
#if($request.masterPage)
  {{displayHierarchy masterPage="$util.encodeURI(${request.masterPage}).replace("+", "%20")" action="$!request.action" remotePage="$util.encodeURI(${request.remotePage}).replace("+", "%20")" hiddenSpaces="$!{request.hiddenSpaces}" hiddenPages="$!{request.hiddenPages}"  editor="$!request.editor" /}}
#end
{{/velocity}}</content>
</xwikidoc>
